<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Medica Scientifica Optimizer - Complete Transparency</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      padding: 2rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: #94a3b8;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    .controls {
      background: #1e293b;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .control-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    label {
      display: block;
      color: #cbd5e1;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    input {
      width: 100%;
      padding: 0.75rem;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      color: #e2e8f0;
      font-size: 1rem;
    }

    button {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .status {
      background: #1e293b;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      border-left: 4px solid #3b82f6;
    }

    .status.success {
      border-left-color: #10b981;
    }

    .results {
      display: none;
    }

    .results.show {
      display: block;
    }

    .result-card {
      background: #1e293b;
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .result-card h2 {
      color: #60a5fa;
      margin-bottom: 1.5rem;
      font-size: 1.8rem;
    }

    .metric-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }

    .metric {
      background: #0f172a;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #334155;
    }

    .metric-label {
      color: #94a3b8;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .metric-value {
      color: #e2e8f0;
      font-size: 1.8rem;
      font-weight: 700;
    }

    .metric-value.positive {
      color: #10b981;
    }

    .metric-value.negative {
      color: #ef4444;
    }

    .timeline {
      background: #0f172a;
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 1rem;
      max-height: 400px;
      overflow-y: auto;
    }

    .action-item {
      padding: 0.75rem;
      background: #1e293b;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      border-left: 3px solid #8b5cf6;
    }

    .action-day {
      color: #60a5fa;
      font-weight: 600;
      margin-right: 1rem;
    }

    .data-table {
      width: 100%;
      margin-top: 1rem;
      background: #0f172a;
      border-radius: 8px;
      overflow: hidden;
    }

    .data-table th {
      background: #1e293b;
      padding: 1rem;
      text-align: left;
      color: #60a5fa;
      font-weight: 600;
    }

    .data-table td {
      padding: 0.75rem 1rem;
      border-top: 1px solid #334155;
    }

    .data-table tr:hover {
      background: #1e293b;
    }

    .loading {
      text-align: center;
      padding: 3rem;
    }

    .spinner {
      border: 4px solid #334155;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .progress-container {
      margin-top: 1.5rem;
    }

    .progress-bar {
      width: 100%;
      height: 24px;
      background: #0f172a;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1rem;
      border: 1px solid #334155;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .progress-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .progress-stat {
      background: #0f172a;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #334155;
    }

    .progress-stat-label {
      color: #94a3b8;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .progress-stat-value {
      color: #e2e8f0;
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* Strategy parameter with toggle */
    .param-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: center;
    }

    .param-label-with-toggle {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .toggle-container {
      position: relative;
      width: 120px;
      height: 32px;
      background: #1e293b;
      border-radius: 16px;
      cursor: pointer;
      border: 1px solid #334155;
      transition: all 0.3s;
    }

    .toggle-container:hover {
      border-color: #475569;
    }

    .toggle-checkbox {
      display: none;
    }

    .toggle-state-label {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.3s;
      pointer-events: none;
    }

    .toggle-state-variable {
      left: 8px;
      color: #a78bfa;
    }

    .toggle-state-fixed {
      right: 8px;
      color: #64748b;
    }

    .toggle-checkbox:checked ~ .toggle-state-variable {
      color: #64748b;
    }

    .toggle-checkbox:checked ~ .toggle-state-fixed {
      color: #60a5fa;
    }

    .toggle-slider-new {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 56px;
      height: 26px;
      background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
      border-radius: 13px;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .toggle-checkbox:checked ~ .toggle-slider-new {
      left: calc(100% - 59px);
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üè≠ Medica Scientifica Optimizer</h1>
    <p class="subtitle">Genetic Algorithm Factory Optimization with Complete Transparency</p>

    <div class="controls">
      <!-- Category 1: Optimizer Settings -->
      <div style="background: #0f172a; padding: 1.5rem; border-radius: 8px; border: 1px solid #334155; margin-bottom: 1.5rem;">
        <h3 style="margin: 0 0 0.3rem 0; color: #cbd5e1; font-size: 1.1rem;">üß¨ Optimizer Settings</h3>
        <p style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #94a3b8;">Configure the genetic algorithm parameters</p>
        <div class="control-group">
          <div>
            <label>Population Size</label>
            <input type="number" id="populationSize" value="100" min="20" max="2000">
          </div>
          <div>
            <label>Generations</label>
            <input type="number" id="generations" value="200" min="50" max="1000">
          </div>
          <div>
            <label>Mutation Rate</label>
            <input type="number" id="mutationRate" value="0.05" min="0.01" max="0.5" step="0.01">
          </div>
          <div>
            <label>Elite Count</label>
            <input type="number" id="eliteCount" value="20" min="5" max="500">
          </div>
        </div>
      </div>

      <!-- Category 2: Environment Variables (Static and Required) -->
      <div style="background: #0f172a; padding: 1.5rem; border-radius: 8px; border: 1px solid #334155; margin-bottom: 1.5rem;">
        <h3 style="margin: 0 0 0.3rem 0; color: #cbd5e1; font-size: 1.1rem;">üåç Environment Variables</h3>
        <p style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #94a3b8;">Current state of your factory and demand forecast (static and required with defaults)</p>

        <h4 style="margin: 1rem 0 0.5rem 0; color: #94a3b8; font-size: 0.95rem;">Current State</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.75rem;">
          <div>
            <label style="font-size: 0.85rem;">Starting Day</label>
            <input type="number" id="reopt_startingDay" value="51" min="51" max="500">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Cash ($)</label>
            <input type="number" id="reopt_cash" value="8206.12" step="0.01">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Debt ($)</label>
            <input type="number" id="reopt_debt" value="70000" step="0.01" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Raw Material</label>
            <input type="number" id="reopt_rawMaterial" value="0" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">MCE Machines</label>
            <input type="number" id="reopt_mce" value="1" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">WMA Machines</label>
            <input type="number" id="reopt_wma" value="1" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">PUC Machines</label>
            <input type="number" id="reopt_puc" value="1" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Expert Workers</label>
            <input type="number" id="reopt_experts" value="1" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Rookie Workers</label>
            <input type="number" id="reopt_rookies" value="0" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Finished Standard</label>
            <input type="number" id="reopt_finishedStandard" value="0" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Finished Custom</label>
            <input type="number" id="reopt_finishedCustom" value="0" min="0">
          </div>
        </div>

        <h4 style="margin: 1.5rem 0 0.5rem 0; color: #94a3b8; font-size: 0.95rem;">Demand Schedule (permanent from day X onward)</h4>
        <div id="demandScheduleEntries">
          <div class="demand-entry" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;">
            <div>
              <label style="font-size: 0.85rem;">Starting Day</label>
              <input type="number" class="demand-day" value="51" min="51" max="500">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Standard Demand</label>
              <input type="number" class="demand-standard" value="10" min="0">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Custom Demand</label>
              <input type="number" class="demand-custom" value="5" min="0">
            </div>
            <button type="button" onclick="removeDemandEntry(this)" style="padding: 0.75rem; background: #dc2626; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.9rem;">‚úï</button>
          </div>
          <div class="demand-entry" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;">
            <div>
              <label style="font-size: 0.85rem;">Starting Day</label>
              <input type="number" class="demand-day" value="172" min="51" max="500">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Standard Demand</label>
              <input type="number" class="demand-standard" value="50" min="0">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Custom Demand</label>
              <input type="number" class="demand-custom" value="20" min="0">
            </div>
            <button type="button" onclick="removeDemandEntry(this)" style="padding: 0.75rem; background: #dc2626; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.9rem;">‚úï</button>
          </div>
          <div class="demand-entry" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;">
            <div>
              <label style="font-size: 0.85rem;">Starting Day</label>
              <input type="number" class="demand-day" value="269" min="51" max="500">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Standard Demand</label>
              <input type="number" class="demand-standard" value="47" min="0">
            </div>
            <div>
              <label style="font-size: 0.85rem;">Custom Demand</label>
              <input type="number" class="demand-custom" value="19" min="0">
            </div>
            <button type="button" onclick="removeDemandEntry(this)" style="padding: 0.75rem; background: #dc2626; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.9rem;">‚úï</button>
          </div>
        </div>
        <button type="button" onclick="addDemandEntry()" style="padding: 0.5rem 1rem; background: #334155; border: none; border-radius: 6px; color: #e2e8f0; cursor: pointer; margin-top: 0.5rem; font-size: 0.9rem;">+ Add Demand Change</button>

        <h4 style="margin: 1.5rem 0 0.5rem 0; color: #94a3b8; font-size: 0.95rem;">Custom Product Market Model</h4>
        <p style="margin: 0 0 0.75rem 0; font-size: 0.8rem; color: #64748b;">
          Define how the custom product market behaves - the external pricing conditions your optimizer must work within (data-driven defaults from historical regression analysis)
        </p>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
          <div>
            <label style="font-size: 0.85rem;">Custom Base Price ($)</label>
            <input type="number" id="env_customBasePrice" value="106.56" min="0" step="0.01">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Target Delivery Days</label>
            <input type="number" id="env_customTarget" value="5" min="1">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Penalty Per Late Day ($)</label>
            <input type="number" id="env_customPenalty" value="0.27" min="0" step="0.01">
          </div>
        </div>
      </div>

      <!-- Category 3: Policy Decisions (Always Variable, Optional, No Defaults) -->
      <div style="background: #0f172a; padding: 1.5rem; border-radius: 8px; border: 1px solid #334155; margin-bottom: 1.5rem;">
        <h3 style="margin: 0 0 0.3rem 0; color: #cbd5e1; font-size: 1.1rem;">‚öôÔ∏è Policy Decisions</h3>
        <p style="margin: 0 0 1rem 0; font-size: 0.85rem; color: #94a3b8;">
          Optional: Input your current policy decisions as seeds for optimization. If left blank, optimizer will explore all possibilities.
          <span style="color: #a78bfa; font-weight: 600;">All policy parameters are variable and can be optimized by the GA.</span>
        </p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
          <div>
            <label style="font-size: 0.85rem;">Reorder Point (units)</label>
            <input type="number" id="reopt_reorderPoint" placeholder="Optional" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Order Quantity (units)</label>
            <input type="number" id="reopt_orderQuantity" placeholder="Optional" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Standard Batch Size (units)</label>
            <input type="number" id="reopt_batchSize" placeholder="Optional" min="1">
          </div>
          <div>
            <label style="font-size: 0.85rem;">MCE Allocation to Custom (%)</label>
            <input type="number" id="reopt_mceAllocation" placeholder="Optional" min="0" max="100">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Standard Product Price ($)</label>
            <input type="number" id="reopt_standardPrice" placeholder="Optional" min="0" step="1">
          </div>
        </div>
      </div>

      <button id="startBtn" onclick="startOptimization()">üöÄ Find Optimal Strategy</button>
    </div>

    <div id="status" class="status" style="display: none;"></div>

    <div id="results" class="results">
      <div class="result-card">
        <h2>üìã Input Configuration Summary</h2>
        <p style="margin-bottom: 1rem; color: #94a3b8;">Complete traceability of all inputs used for this optimization run.</p>
        <div id="inputConfigSummary"></div>
      </div>

      <div class="result-card">
        <h2 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
          <span>üìä Optimal Strategy Found</span>
          <div style="display: flex; gap: 0.5rem;">
            <button class="export-btn" onclick="exportState()" style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">üì§ Export State</button>
            <button class="export-btn" onclick="document.getElementById('importStateFile').click()" style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem; background: #059669;">üì• Import State</button>
            <input type="file" id="importStateFile" accept=".json" style="display: none;" onchange="importState(this)">
          </div>
        </h2>
        <div class="metric-grid" id="finalMetrics"></div>
      </div>

      <div class="result-card">
        <h2>‚öôÔ∏è Recommended Policy Settings</h2>
        <div class="metric-grid" id="policySettings"></div>
      </div>

      <div class="result-card">
        <h2 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
          <span>üìÖ Prescribed Action Timeline</span>
          <button class="export-btn" onclick="exportActionsToCSV()" style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">üì• Export Action Timeline CSV</button>
        </h2>
        <div class="timeline" id="actionTimeline"></div>
      </div>

      <div class="result-card">
        <h2 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
          <span>üìà Complete Daily Forecast - ACTIVE MANAGEMENT PERIOD (Days 51-268)</span>
          <button class="export-btn" onclick="exportToCSV('active')" style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">üì• Export Active Period CSV</button>
        </h2>
        <p style="margin-bottom: 1rem; color: #94a3b8;">All metrics during active operations when you can make decisions and take actions.</p>
        <div id="activeManagementForecast"></div>
      </div>

      <div class="result-card">
        <h2 style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
          <span>üìä Complete Daily Forecast - RUNOFF PERIOD (Days 269-500)</span>
          <button class="export-btn" onclick="exportToCSV('runoff')" style="width: auto; padding: 0.5rem 1rem; font-size: 0.9rem;">üì• Export Runoff Period CSV</button>
        </h2>
        <p style="margin-bottom: 1rem; color: #94a3b8;">All metrics during runoff when operations wind down to final cash position.</p>
        <div id="runoffForecast"></div>
      </div>

      <div class="result-card">
        <h2 style="text-align: center;">
          <button class="export-btn-large" onclick="exportToCSV('complete')" style="width: 100%; padding: 1rem 2rem; font-size: 1.1rem;">üì• Export Complete Forecast CSV (All Days 51-500)</button>
        </h2>
      </div>
    </div>
  </div>

  <script>
    // Helper functions for demand schedule entries
    function addDemandEntry() {
      const container = document.getElementById('demandScheduleEntries');
      const entryHtml = `
        <div class="demand-entry" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;">
          <div>
            <label style="font-size: 0.85rem;">Starting Day</label>
            <input type="number" class="demand-day" placeholder="e.g., 300" min="51" max="500">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Standard Demand (from this day on)</label>
            <input type="number" class="demand-standard" placeholder="e.g., 40" min="0">
          </div>
          <div>
            <label style="font-size: 0.85rem;">Custom Demand (from this day on)</label>
            <input type="number" class="demand-custom" placeholder="e.g., 15" min="0">
          </div>
          <button type="button" onclick="removeDemandEntry(this)" style="padding: 0.75rem; background: #dc2626; border: none; border-radius: 6px; color: white; cursor: pointer; font-size: 0.9rem;">‚úï</button>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', entryHtml);
    }

    function removeDemandEntry(button) {
      button.parentElement.remove();
    }

    // Build starting state from form fields
    function buildStartingState() {
      // Get all form values
      const currentDay = parseInt(document.getElementById('reopt_startingDay').value) || 51;
      const cash = parseFloat(document.getElementById('reopt_cash').value) || 8206.12;
      const debt = parseFloat(document.getElementById('reopt_debt').value) || 70000;
      const rawMaterialInventory = parseInt(document.getElementById('reopt_rawMaterial').value) || 0;

      const machines = {
        MCE: parseInt(document.getElementById('reopt_mce').value) || 1,
        WMA: parseInt(document.getElementById('reopt_wma').value) || 1,
        PUC: parseInt(document.getElementById('reopt_puc').value) || 1
      };

      const workforce = {
        experts: parseInt(document.getElementById('reopt_experts').value) || 1,
        rookies: parseInt(document.getElementById('reopt_rookies').value) || 0,
        rookiesInTraining: []
      };

      const finishedGoods = {
        standard: parseInt(document.getElementById('reopt_finishedStandard').value) || 0,
        custom: parseInt(document.getElementById('reopt_finishedCustom').value) || 0
      };

      // Build minimal starting state (complex WIP structures will be empty)
      return {
        currentDay,
        cash,
        debt,
        rawMaterialInventory,
        standardLineWIP: {
          preStation1: [],
          station1: [],
          station2: [],
          station3: []
        },
        customLineWIP: {
          orders: []
        },
        finishedGoods,
        workforce,
        machines,
        pendingRawMaterialOrders: [],
        history: {
          dailyCash: [],
          dailyDebt: [],
          dailyNetWorth: [],
          dailyRevenue: [],
          dailyExpenses: [],
          dailyInterestPaid: [],
          dailyInterestEarned: [],
          dailyStandardProduction: [],
          dailyCustomProduction: [],
          dailyStandardWIP: [],
          dailyCustomWIP: [],
          dailyFinishedStandard: [],
          dailyFinishedCustom: [],
          dailyRawMaterial: [],
          dailyRawMaterialOrders: [],
          dailyRawMaterialCost: [],
          dailyExperts: [],
          dailyRookies: [],
          dailyRookiesInTraining: [],
          dailySalaryCost: [],
          dailyMCECount: [],
          dailyWMACount: [],
          dailyPUCCount: [],
          dailyStandardPrice: [],
          dailyCustomPrice: [],
          dailyCustomDeliveryTime: [],
          actionsPerformed: []
        }
      };
    }

    // Build demand forecast from schedule (permanent from day X forward)
    function buildDemandSchedule() {
      const demandEntries = document.querySelectorAll('.demand-entry');
      const schedule = [];

      demandEntries.forEach(entry => {
        const day = entry.querySelector('.demand-day').value;
        const standardDemand = entry.querySelector('.demand-standard').value;
        const customDemand = entry.querySelector('.demand-custom').value;

        if (day && standardDemand !== '' && customDemand !== '') {
          schedule.push({
            day: parseInt(day),
            standardDemand: parseInt(standardDemand),
            customDemand: parseInt(customDemand)
          });
        }
      });

      // Sort by day
      schedule.sort((a, b) => a.day - b.day);

      // Build full forecast: for each day 51-500, find the most recent schedule entry
      const fullForecast = [];
      for (let day = 51; day <= 500; day++) {
        // Find the most recent schedule entry that applies to this day
        let applicableEntry = null;
        for (const entry of schedule) {
          if (entry.day <= day) {
            applicableEntry = entry;
          } else {
            break; // Schedule is sorted, so we can stop
          }
        }

        if (applicableEntry) {
          fullForecast.push({
            day,
            standardDemand: applicableEntry.standardDemand,
            customDemand: applicableEntry.customDemand
          });
        }
      }

      return fullForecast.length > 0 ? fullForecast : null;
    }

    async function startOptimization() {
      const btn = document.getElementById('startBtn');
      const status = document.getElementById('status');
      const results = document.getElementById('results');

      btn.disabled = true;
      status.style.display = 'block';
      status.className = 'status';
      status.innerHTML = '<div class="loading"><div class="spinner"></div><strong>Optimization in progress...</strong><br>Check the terminal for detailed progress logs</div>';
      results.classList.remove('show');

      const config = {
        populationSize: parseInt(document.getElementById('populationSize').value),
        generations: parseInt(document.getElementById('generations').value),
        mutationRate: parseFloat(document.getElementById('mutationRate').value),
        eliteCount: parseInt(document.getElementById('eliteCount').value),
        crossoverRate: 0.7
      };

      // Parse optional re-optimization parameters
      const requestData = { config };

      // Build starting state from form fields or use imported state
      if (importedState) {
        requestData.startingState = importedState;
        console.log('Using imported starting state from day:', importedState.currentDay);
      } else {
        // Check if user has modified any starting point fields from defaults
        const startingDay = parseInt(document.getElementById('reopt_startingDay').value);
        const cash = parseFloat(document.getElementById('reopt_cash').value);
        const hasCustomStart = startingDay !== 51 || Math.abs(cash - 8206.12) > 0.01;

        if (hasCustomStart) {
          requestData.startingState = buildStartingState();
          console.log('Using custom starting state from day:', requestData.startingState.currentDay);
        }
      }

      // Build demand forecast from schedule
      const demandForecast = buildDemandSchedule();
      if (demandForecast) {
        requestData.demandForecast = demandForecast;
        console.log('Using custom demand schedule with', demandForecast.length, 'total days defined');
      }

      // Read custom market model from environment variables (fixed params)
      const fixedParams = {
        customBasePrice: parseFloat(document.getElementById('env_customBasePrice').value) || 106.56,
        customTargetDeliveryDays: parseInt(document.getElementById('env_customTarget').value) || 5,
        customPenaltyPerDay: parseFloat(document.getElementById('env_customPenalty').value) || 0.27
      };

      // Read policy decision values (all are variable and optional)
      const variableParams = {};

      const reorderPointVal = document.getElementById('reopt_reorderPoint').value;
      const orderQuantityVal = document.getElementById('reopt_orderQuantity').value;
      const batchSizeVal = document.getElementById('reopt_batchSize').value;
      const mceAllocationVal = document.getElementById('reopt_mceAllocation').value;
      const standardPriceVal = document.getElementById('reopt_standardPrice').value;

      // Only include policy decisions that have values (optional)
      if (reorderPointVal !== '') {
        variableParams.reorderPoint = parseInt(reorderPointVal);
      }
      if (orderQuantityVal !== '') {
        variableParams.orderQuantity = parseInt(orderQuantityVal);
      }
      if (batchSizeVal !== '') {
        variableParams.standardBatchSize = parseInt(batchSizeVal);
      }
      if (mceAllocationVal !== '') {
        variableParams.mceAllocationCustom = parseFloat(mceAllocationVal) / 100;
      }
      if (standardPriceVal !== '') {
        variableParams.standardPrice = parseInt(standardPriceVal);
      }

      // Add strategy configuration to config
      config.fixedParams = fixedParams;
      config.variableParams = variableParams;

      console.log('üîí Fixed market model (external conditions):', fixedParams);
      if (Object.keys(variableParams).length > 0) {
        console.log('üîÑ Variable policy parameters (seeds for optimization):', variableParams);
      } else {
        console.log('üîÑ No policy seeds specified - GA will explore all operational possibilities');
      }

      try {
        const response = await fetch('/api/optimize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));

              if (data.type === 'progress') {
                // Progress updates handled in terminal
              } else if (data.type === 'complete') {
                status.className = 'status success';
                status.innerHTML = `<strong>‚úÖ Optimization Complete!</strong><br>Found optimal strategy in ${config.generations} generations`;
                displayResults(data.result, config, requestData);
                results.classList.add('show');
              } else if (data.type === 'error') {
                status.className = 'status';
                status.innerHTML = `<strong>‚ùå Error:</strong> ${data.error}`;
              }
            }
          }
        }
      } catch (error) {
        status.className = 'status';
        status.innerHTML = `<strong>‚ùå Error:</strong> ${error.message}`;
      } finally {
        btn.disabled = false;
      }
    }

    function displayResults(result, config, requestData) {
      const { bestStrategy, finalSimulation } = result;

      // Store strategy, state, config, and request data for CSV export and re-optimization
      storeBestStrategy(bestStrategy);
      storeFinalState(finalSimulation.state);
      globalConfig = config;
      globalRequestData = requestData;

      // Input Configuration Summary
      const startingState = requestData.startingState;
      const demandForecast = requestData.demandForecast;
      const fixedParams = config.fixedParams;
      const variableParams = config.variableParams;

      let inputConfigHTML = '<div style="display: grid; gap: 1.5rem;">';

      // Optimizer Settings
      inputConfigHTML += `
        <div>
          <h3 style="color: #60a5fa; margin: 0 0 0.75rem 0; font-size: 1rem;">Optimizer Settings</h3>
          <div class="metric-grid">
            <div class="metric">
              <div class="metric-label">Population Size</div>
              <div class="metric-value">${config.populationSize}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Generations</div>
              <div class="metric-value">${config.generations}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Mutation Rate</div>
              <div class="metric-value">${(config.mutationRate * 100).toFixed(1)}%</div>
            </div>
            <div class="metric">
              <div class="metric-label">Elite Count</div>
              <div class="metric-value">${config.eliteCount}</div>
            </div>
          </div>
        </div>
      `;

      // Environment Variables - Starting State
      inputConfigHTML += `
        <div>
          <h3 style="color: #60a5fa; margin: 0 0 0.75rem 0; font-size: 1rem;">Environment Variables - Starting State</h3>
          <div class="metric-grid">
            <div class="metric">
              <div class="metric-label">Starting Day</div>
              <div class="metric-value">${startingState ? startingState.currentDay : 51}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Initial Cash</div>
              <div class="metric-value">$${startingState ? startingState.cash.toFixed(2) : '8206.12'}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Initial Debt</div>
              <div class="metric-value">$${startingState ? startingState.debt.toFixed(2) : '70000.00'}</div>
            </div>
            <div class="metric">
              <div class="metric-label">MCE Machines</div>
              <div class="metric-value">${startingState ? startingState.machines.MCE : 1}</div>
            </div>
            <div class="metric">
              <div class="metric-label">WMA Machines</div>
              <div class="metric-value">${startingState ? startingState.machines.WMA : 1}</div>
            </div>
            <div class="metric">
              <div class="metric-label">PUC Machines</div>
              <div class="metric-value">${startingState ? startingState.machines.PUC : 1}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Expert Workers</div>
              <div class="metric-value">${startingState ? startingState.workforce.experts : 1}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Rookie Workers</div>
              <div class="metric-value">${startingState ? startingState.workforce.rookies : 0}</div>
            </div>
          </div>
        </div>
      `;

      // Environment Variables - Market Model
      inputConfigHTML += `
        <div>
          <h3 style="color: #60a5fa; margin: 0 0 0.75rem 0; font-size: 1rem;">Environment Variables - Custom Market Model (Fixed)</h3>
          <div class="metric-grid">
            <div class="metric">
              <div class="metric-label">Custom Base Price</div>
              <div class="metric-value">$${fixedParams.customBasePrice.toFixed(2)}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Target Delivery Days</div>
              <div class="metric-value">${fixedParams.customTargetDeliveryDays}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Penalty Per Late Day</div>
              <div class="metric-value">$${fixedParams.customPenaltyPerDay.toFixed(2)}</div>
            </div>
          </div>
        </div>
      `;

      // Demand Schedule
      if (demandForecast) {
        inputConfigHTML += `
          <div>
            <h3 style="color: #60a5fa; margin: 0 0 0.75rem 0; font-size: 1rem;">Custom Demand Schedule</h3>
            <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">${demandForecast.length} days with custom demand defined</p>
          </div>
        `;
      } else {
        inputConfigHTML += `
          <div>
            <h3 style="color: #60a5fa; margin: 0 0 0.75rem 0; font-size: 1rem;">Demand Schedule</h3>
            <p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">Using default demand curve from business case</p>
          </div>
        `;
      }

      // Policy Seeds
      const hasPolicySeeds = Object.keys(variableParams).length > 0;
      inputConfigHTML += `
        <div>
          <h3 style="color: #60a5fa; margin: 0 0 0.75rem 0; font-size: 1rem;">Policy Decision Seeds (Variable Parameters)</h3>
      `;

      if (hasPolicySeeds) {
        inputConfigHTML += '<div class="metric-grid">';

        if (variableParams.reorderPoint !== undefined) {
          inputConfigHTML += `
            <div class="metric">
              <div class="metric-label">Reorder Point (seed)</div>
              <div class="metric-value">${variableParams.reorderPoint} units</div>
            </div>
          `;
        }
        if (variableParams.orderQuantity !== undefined) {
          inputConfigHTML += `
            <div class="metric">
              <div class="metric-label">Order Quantity (seed)</div>
              <div class="metric-value">${variableParams.orderQuantity} units</div>
            </div>
          `;
        }
        if (variableParams.standardBatchSize !== undefined) {
          inputConfigHTML += `
            <div class="metric">
              <div class="metric-label">Standard Batch Size (seed)</div>
              <div class="metric-value">${variableParams.standardBatchSize} units</div>
            </div>
          `;
        }
        if (variableParams.mceAllocationCustom !== undefined) {
          inputConfigHTML += `
            <div class="metric">
              <div class="metric-label">MCE Allocation Custom (seed)</div>
              <div class="metric-value">${(variableParams.mceAllocationCustom * 100).toFixed(1)}%</div>
            </div>
          `;
        }
        if (variableParams.standardPrice !== undefined) {
          inputConfigHTML += `
            <div class="metric">
              <div class="metric-label">Standard Price (seed)</div>
              <div class="metric-value">$${variableParams.standardPrice}</div>
            </div>
          `;
        }

        inputConfigHTML += '</div>';
      } else {
        inputConfigHTML += '<p style="margin: 0; color: #94a3b8; font-size: 0.9rem;">No policy seeds provided - optimizer explored all operational possibilities</p>';
      }

      inputConfigHTML += '</div></div>';

      document.getElementById('inputConfigSummary').innerHTML = inputConfigHTML;

      // Final Metrics
      document.getElementById('finalMetrics').innerHTML = `
        <div class="metric">
          <div class="metric-label">Final Cash</div>
          <div class="metric-value positive">$${finalSimulation.finalCash.toFixed(2)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Final Debt</div>
          <div class="metric-value negative">$${finalSimulation.finalDebt.toFixed(2)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Net Worth</div>
          <div class="metric-value positive">$${finalSimulation.finalNetWorth.toFixed(2)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Fitness Score</div>
          <div class="metric-value">$${finalSimulation.fitnessScore.toFixed(2)}</div>
        </div>
      `;

      // Policy Settings
      document.getElementById('policySettings').innerHTML = `
        <div class="metric">
          <div class="metric-label">Raw Material Reorder Point</div>
          <div class="metric-value">${bestStrategy.reorderPoint} units</div>
        </div>
        <div class="metric">
          <div class="metric-label">Raw Material Order Quantity</div>
          <div class="metric-value">${bestStrategy.orderQuantity} units</div>
        </div>
        <div class="metric">
          <div class="metric-label">Standard Batch Size</div>
          <div class="metric-value">${bestStrategy.standardBatchSize} units</div>
        </div>
        <div class="metric">
          <div class="metric-label">MCE Allocation to Custom</div>
          <div class="metric-value">${(bestStrategy.mceAllocationCustom * 100).toFixed(1)}%</div>
        </div>
        <div class="metric">
          <div class="metric-label">Standard Product Price</div>
          <div class="metric-value">$${bestStrategy.standardPrice}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Custom Base Price</div>
          <div class="metric-value">$${bestStrategy.customBasePrice.toFixed(2)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Custom Penalty Per Day</div>
          <div class="metric-value">$${bestStrategy.customPenaltyPerDay.toFixed(2)}</div>
        </div>
        <div class="metric">
          <div class="metric-label">Custom Target Delivery</div>
          <div class="metric-value">${bestStrategy.customTargetDeliveryDays} days</div>
        </div>
      `;

      // Action Timeline
      const timeline = bestStrategy.timedActions.map(action => {
        let desc = '';
        switch(action.type) {
          case 'TAKE_LOAN': desc = `Take loan of $${action.amount}`; break;
          case 'HIRE_ROOKIE': desc = `Hire ${action.count} rookie(s)`; break;
          case 'BUY_MACHINE': desc = `Buy ${action.count} ${action.machineType} machine(s)`; break;
          case 'ORDER_MATERIALS': desc = `Order ${action.quantity} units of raw materials`; break;
          default: desc = action.type;
        }
        return `<div class="action-item"><span class="action-day">Day ${action.day}:</span>${desc}</div>`;
      }).join('');
      document.getElementById('actionTimeline').innerHTML = timeline || '<p style="color: #94a3b8;">No timed actions in optimal strategy</p>';

      // Daily Forecast - Split into Active Management and Runoff periods
      displayDailyForecast(finalSimulation.state.history);
    }

    function displayDailyForecast(history) {
      // Store history for CSV export
      storeHistoryData(history);

      const ACTIVE_PERIOD_END = 268; // Day 268 is end of active management

      const tables = [
        { title: 'Financial Metrics', metrics: ['dailyCash', 'dailyDebt', 'dailyNetWorth', 'dailyRevenue', 'dailyExpenses', 'dailyInterestPaid', 'dailyInterestEarned'] },
        { title: 'Production Metrics', metrics: ['dailyStandardProduction', 'dailyCustomProduction', 'dailyStandardWIP', 'dailyCustomWIP', 'dailyFinishedStandard', 'dailyFinishedCustom'] },
        { title: 'Inventory Metrics', metrics: ['dailyRawMaterial', 'dailyRawMaterialOrders', 'dailyRawMaterialCost'] },
        { title: 'Workforce Metrics', metrics: ['dailyExperts', 'dailyRookies', 'dailyRookiesInTraining', 'dailySalaryCost'] },
        { title: 'Machine Metrics', metrics: ['dailyMCECount', 'dailyWMACount', 'dailyPUCCount'] },
        { title: 'Pricing Metrics', metrics: ['dailyStandardPrice', 'dailyCustomPrice', 'dailyCustomDeliveryTime'] },
      ];

      // Active Management Period (Days 51-268)
      let activeHtml = '';
      for (const table of tables) {
        activeHtml += `<h3 style="margin-top: 2rem; color: #60a5fa;">${table.title}</h3>`;
        activeHtml += '<table class="data-table"><thead><tr><th>Day</th>';
        table.metrics.forEach(m => {
          activeHtml += `<th>${m.replace('daily', '').replace(/([A-Z])/g, ' $1').trim()}</th>`;
        });
        activeHtml += '</tr></thead><tbody>';

        // Get data for active period
        const allDays = history[table.metrics[0]];
        const activeDays = allDays.filter(d => d.day >= 51 && d.day <= ACTIVE_PERIOD_END);

        activeDays.forEach((item) => {
          activeHtml += `<tr><td><strong>Day ${item.day}</strong></td>`;
          table.metrics.forEach(m => {
            const dataPoint = history[m].find(d => d.day === item.day);
            const value = dataPoint?.value || 0;
            activeHtml += `<td>${typeof value === 'number' ? value.toFixed(2) : value}</td>`;
          });
          activeHtml += '</tr>';
        });

        activeHtml += '</tbody></table>';
      }
      document.getElementById('activeManagementForecast').innerHTML = activeHtml;

      // Runoff Period (Days 269-500)
      let runoffHtml = '';
      for (const table of tables) {
        runoffHtml += `<h3 style="margin-top: 2rem; color: #60a5fa;">${table.title}</h3>`;
        runoffHtml += '<table class="data-table"><thead><tr><th>Day</th>';
        table.metrics.forEach(m => {
          runoffHtml += `<th>${m.replace('daily', '').replace(/([A-Z])/g, ' $1').trim()}</th>`;
        });
        runoffHtml += '</tr></thead><tbody>';

        // Get data for runoff period
        const allDays = history[table.metrics[0]];
        const runoffDays = allDays.filter(d => d.day > ACTIVE_PERIOD_END);

        runoffDays.forEach((item) => {
          runoffHtml += `<tr><td><strong>Day ${item.day}</strong></td>`;
          table.metrics.forEach(m => {
            const dataPoint = history[m].find(d => d.day === item.day);
            const value = dataPoint?.value || 0;
            runoffHtml += `<td>${typeof value === 'number' ? value.toFixed(2) : value}</td>`;
          });
          runoffHtml += '</tr>';
        });

        runoffHtml += '</tbody></table>';
      }
      document.getElementById('runoffForecast').innerHTML = runoffHtml;
    }

    // Store history data, strategy, and final state globally for CSV export and re-optimization
    let globalHistory = null;
    let globalBestStrategy = null;
    let globalFinalState = null;
    let globalConfig = null;
    let globalRequestData = null;

    function storeHistoryData(history) {
      globalHistory = history;
    }

    function storeBestStrategy(strategy) {
      globalBestStrategy = strategy;
    }

    function storeFinalState(state) {
      globalFinalState = state;
    }

    let importedState = null;

    function exportState() {
      if (!globalFinalState) {
        alert('No simulation state available to export');
        return;
      }

      // Export final state as JSON for re-optimization
      const stateJSON = JSON.stringify(globalFinalState, null, 2);
      const blob = new Blob([stateJSON], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `simulation-state-day-${globalFinalState.currentDay}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importState(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          importedState = JSON.parse(e.target.result);
          alert(`‚úÖ State imported successfully!\n\nStarting Day: ${importedState.currentDay}\nCash: $${importedState.cash.toFixed(2)}\nDebt: $${importedState.debt.toFixed(2)}\n\nThis state will be used for the next optimization run.`);
        } catch (error) {
          alert('‚ùå Error importing state: ' + error.message);
          importedState = null;
        }
      };
      reader.readAsText(file);
      input.value = ''; // Reset file input
    }

    function exportToCSV(period) {
      if (!globalHistory) {
        alert('No forecast data available. Please run optimization first.');
        return;
      }

      const ACTIVE_PERIOD_END = 268;
      const allMetrics = [
        'dailyCash', 'dailyDebt', 'dailyNetWorth', 'dailyRevenue', 'dailyExpenses',
        'dailyInterestPaid', 'dailyInterestEarned', 'dailyStandardProduction',
        'dailyCustomProduction', 'dailyStandardWIP', 'dailyCustomWIP',
        'dailyFinishedStandard', 'dailyFinishedCustom', 'dailyRawMaterial',
        'dailyRawMaterialOrders', 'dailyRawMaterialCost', 'dailyExperts',
        'dailyRookies', 'dailyRookiesInTraining', 'dailySalaryCost',
        'dailyMCECount', 'dailyWMACount', 'dailyPUCCount', 'dailyStandardPrice',
        'dailyCustomPrice', 'dailyCustomDeliveryTime'
      ];

      // Get all days from first metric
      const allDays = globalHistory[allMetrics[0]];
      let filteredDays;
      let filename;

      if (period === 'active') {
        filteredDays = allDays.filter(d => d.day >= 51 && d.day <= ACTIVE_PERIOD_END);
        filename = 'medica-scientifica-active-period-forecast.csv';
      } else if (period === 'runoff') {
        filteredDays = allDays.filter(d => d.day > ACTIVE_PERIOD_END);
        filename = 'medica-scientifica-runoff-period-forecast.csv';
      } else {
        filteredDays = allDays.filter(d => d.day >= 51);
        filename = 'medica-scientifica-complete-forecast.csv';
      }

      // Add metadata headers for reproducibility
      let csvContent = '';

      if (globalConfig && globalRequestData) {
        const timestamp = new Date().toISOString();
        const startingState = globalRequestData.startingState;
        const fixedParams = globalConfig.fixedParams;
        const variableParams = globalConfig.variableParams;

        csvContent += `# Medica Scientifica Optimization Results\n`;
        csvContent += `# Generated: ${timestamp}\n`;
        csvContent += `# Period: ${period === 'active' ? 'Active Management (Days 51-268)' : period === 'runoff' ? 'Runoff (Days 269-500)' : 'Complete (Days 51-500)'}\n`;
        csvContent += `#\n`;
        csvContent += `# OPTIMIZER CONFIGURATION:\n`;
        csvContent += `# Population: ${globalConfig.populationSize}, Generations: ${globalConfig.generations}, Mutation Rate: ${(globalConfig.mutationRate * 100).toFixed(1)}%, Elite Count: ${globalConfig.eliteCount}\n`;
        csvContent += `#\n`;
        csvContent += `# MARKET MODEL (FIXED ENVIRONMENT):\n`;
        csvContent += `# Custom Base Price: $${fixedParams.customBasePrice.toFixed(2)}, Target Delivery: ${fixedParams.customTargetDeliveryDays} days, Penalty Per Day: $${fixedParams.customPenaltyPerDay.toFixed(2)}\n`;
        csvContent += `#\n`;
        csvContent += `# STARTING STATE:\n`;
        csvContent += `# Day: ${startingState ? startingState.currentDay : 51}, Cash: $${startingState ? startingState.cash.toFixed(2) : '8206.12'}, Debt: $${startingState ? startingState.debt.toFixed(2) : '70000.00'}\n`;
        csvContent += `# Machines: MCE=${startingState ? startingState.machines.MCE : 1}, WMA=${startingState ? startingState.machines.WMA : 1}, PUC=${startingState ? startingState.machines.PUC : 1}\n`;
        csvContent += `# Workforce: Experts=${startingState ? startingState.workforce.experts : 1}, Rookies=${startingState ? startingState.workforce.rookies : 0}\n`;
        csvContent += `#\n`;
        csvContent += `# DEMAND SCHEDULE:\n`;
        csvContent += `# ${globalRequestData.demandForecast ? globalRequestData.demandForecast.length + ' days with custom demand' : 'Default demand curve from business case'}\n`;
        csvContent += `#\n`;
        csvContent += `# POLICY SEEDS (VARIABLE PARAMETERS):\n`;

        if (Object.keys(variableParams).length > 0) {
          const seedsList = [];
          if (variableParams.reorderPoint !== undefined) seedsList.push(`Reorder Point: ${variableParams.reorderPoint}`);
          if (variableParams.orderQuantity !== undefined) seedsList.push(`Order Quantity: ${variableParams.orderQuantity}`);
          if (variableParams.standardBatchSize !== undefined) seedsList.push(`Batch Size: ${variableParams.standardBatchSize}`);
          if (variableParams.mceAllocationCustom !== undefined) seedsList.push(`MCE Allocation: ${(variableParams.mceAllocationCustom * 100).toFixed(1)}%`);
          if (variableParams.standardPrice !== undefined) seedsList.push(`Standard Price: $${variableParams.standardPrice}`);
          csvContent += `# ${seedsList.join(', ')}\n`;
        } else {
          csvContent += `# No policy seeds - optimizer explored all operational possibilities\n`;
        }

        csvContent += `#\n`;
        csvContent += `# DATA COLUMNS:\n`;
      }

      // Create CSV header (add Actions column)
      const headers = ['Day', ...allMetrics.map(m =>
        m.replace('daily', '').replace(/([A-Z])/g, ' $1').trim()
      ), 'Action'];
      csvContent += headers.join(',') + '\n';

      // Add data rows
      filteredDays.forEach(dayItem => {
        const row = [dayItem.day];
        allMetrics.forEach(metric => {
          const dataPoint = globalHistory[metric].find(d => d.day === dayItem.day);
          const value = dataPoint?.value ?? 0;
          row.push(typeof value === 'number' ? value.toFixed(2) : value);
        });

        // Add action for this day (if any)
        let actionDesc = '';
        if (globalBestStrategy) {
          const action = globalBestStrategy.timedActions.find(a => a.day === dayItem.day);
          if (action) {
            switch(action.type) {
              case 'TAKE_LOAN': actionDesc = `Take loan of $${action.amount}`; break;
              case 'HIRE_ROOKIE': actionDesc = `Hire ${action.count} rookie(s)`; break;
              case 'BUY_MACHINE': actionDesc = `Buy ${action.count} ${action.machineType} machine(s)`; break;
              case 'ORDER_MATERIALS': actionDesc = `Order ${action.quantity} units of raw materials`; break;
              default: actionDesc = action.type;
            }
          }
        }
        row.push(`"${actionDesc}"`); // Quote to handle commas in description

        csvContent += row.join(',') + '\n';
      });

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportActionsToCSV() {
      if (!globalBestStrategy) {
        alert('No strategy data available. Please run optimization first.');
        return;
      }

      // Add metadata headers for reproducibility
      let csvContent = '';

      if (globalConfig && globalRequestData) {
        const timestamp = new Date().toISOString();
        const startingState = globalRequestData.startingState;
        const fixedParams = globalConfig.fixedParams;

        csvContent += `# Medica Scientifica Action Timeline\n`;
        csvContent += `# Generated: ${timestamp}\n`;
        csvContent += `#\n`;
        csvContent += `# OPTIMIZER CONFIGURATION:\n`;
        csvContent += `# Population: ${globalConfig.populationSize}, Generations: ${globalConfig.generations}, Mutation Rate: ${(globalConfig.mutationRate * 100).toFixed(1)}%, Elite Count: ${globalConfig.eliteCount}\n`;
        csvContent += `#\n`;
        csvContent += `# MARKET MODEL (FIXED ENVIRONMENT):\n`;
        csvContent += `# Custom Base Price: $${fixedParams.customBasePrice.toFixed(2)}, Target Delivery: ${fixedParams.customTargetDeliveryDays} days, Penalty Per Day: $${fixedParams.customPenaltyPerDay.toFixed(2)}\n`;
        csvContent += `#\n`;
        csvContent += `# STARTING STATE:\n`;
        csvContent += `# Day: ${startingState ? startingState.currentDay : 51}, Cash: $${startingState ? startingState.cash.toFixed(2) : '8206.12'}, Debt: $${startingState ? startingState.debt.toFixed(2) : '70000.00'}\n`;
        csvContent += `#\n`;
        csvContent += `# PRESCRIBED ACTIONS:\n`;
      }

      // Create CSV header
      csvContent += 'Day,Action Type,Description,Amount/Count/Machine Type\n';

      // Add action rows
      globalBestStrategy.timedActions.forEach(action => {
        let desc = '';
        let details = '';

        switch(action.type) {
          case 'TAKE_LOAN':
            desc = `Take loan of $${action.amount}`;
            details = action.amount;
            break;
          case 'HIRE_ROOKIE':
            desc = `Hire ${action.count} rookie(s)`;
            details = action.count;
            break;
          case 'BUY_MACHINE':
            desc = `Buy ${action.count} ${action.machineType} machine(s)`;
            details = action.machineType;
            break;
          case 'ORDER_MATERIALS':
            desc = `Order ${action.quantity} units of raw materials`;
            details = action.quantity;
            break;
          default:
            desc = action.type;
            details = '';
        }

        csvContent += `${action.day},${action.type},"${desc}",${details}\n`;
      });

      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'medica-scientifica-action-timeline.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>
